document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ Iniciando script...');
    
    /* ========================================
       CONFIGURA√á√ïES DO POPUP - F√ÅCIL DE CONTROLAR
    ======================================== */
    const POPUP_CONFIG = {
        // TEMPO PARA O POPUP APARECER (em milissegundos)
        tempoParaAparecer: 20000, // Imediatamente
        
        // TEMPO PARA O BOT√ÉO APARECER AP√ìS O POPUP (em milissegundos)
        tempoParaBotaoAparecer: 5000, // Bot√£o aparece junto com o popup
        
        // INTERVALO DE REDU√á√ÉO DAS VAGAS (em milissegundos)
        intervaloVagas: 10000, // 5 segundos (5000ms)
        
        // LINK DE REDIRECIONAMENTO
        linkRedirecionamento: 'https://quiz.cakto.com.br/ebook-quiropraxia-hoNDsM',
        
        // VAGAS INICIAIS
        vagasIniciais: 19,
        
        // CONFIGURA√á√ÉO DO CONTADOR DE PESSOAS
        pessoasIniciais: 478, // N√∫mero inicial de pessoas que fizeram
        incrementoPessoas: 1, // Quantas pessoas aumentam a cada vaga que diminui
    };
    
    console.log('‚öôÔ∏è Configura√ß√µes carregadas:', POPUP_CONFIG);
    
    /* ========================================
       HELPER FUNCTIONS - VERIFICA√á√ÉO SEGURA DE ELEMENTOS
    ======================================== */
    const safeElementUpdate = (elementId, value, logPrefix = '') => {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = value;
            console.log(`‚úÖ ${logPrefix}${elementId} atualizado para: ${value}`);
            return true;
        } else {
            console.warn(`‚ö†Ô∏è ${logPrefix}Elemento #${elementId} n√£o encontrado - opera√ß√£o ignorada`);
            return false;
        }
    };

    const safeElementExists = (elementId) => {
        const element = document.getElementById(elementId);
        const exists = !!element;
        console.log(`üîç Elemento #${elementId}: ${exists ? '‚úÖ encontrado' : '‚ùå n√£o encontrado'}`);
        return { exists, element };
    };
    
    /* ========================================
       L√ìGICA DA BARRA DE PROGRESSO
    ======================================== */
    const progressBar = document.getElementById('quiz-progress-bar');
    console.log('üìä Barra de progresso encontrada:', !!progressBar);

    window.updateProgressBar = function(percentage) {
        if (progressBar) {
            if (percentage >= 0 && percentage <= 100) {
                progressBar.style.width = `${percentage}%`;
                console.log(`üìä Barra atualizada para: ${percentage}%`);
            } else {
                console.warn('Porcentagem inv√°lida para a barra de progresso. Use valores entre 0 e 100.');
            }
        } else {
            console.warn('‚ö†Ô∏è Barra de progresso n√£o encontrada - updateProgressBar ignorado');
        }
    };

    // Inicia a barra em 10%
    if (progressBar) {
        updateProgressBar(10);
    }

    /* ========================================
       L√ìGICA DO CARROSSEL
    ======================================== */
    const carouselContainer = document.querySelector('.carousel-container');
    const carouselSlides = document.querySelector('.carousel-slides');
    const carouselImages = document.querySelectorAll('.carousel-slides img');
    const prevButton = document.querySelector('.carousel-button.prev');
    const nextButton = document.querySelector('.carousel-button.next');
    const dotsContainer = document.querySelector('.carousel-dots');
    
    console.log('üé† Elementos do carrossel:');
    console.log('- Container:', !!carouselContainer);
    console.log('- Slides:', !!carouselSlides);
    console.log('- Imagens:', carouselImages.length);
    console.log('- Bot√£o anterior:', !!prevButton);
    console.log('- Bot√£o pr√≥ximo:', !!nextButton);
    console.log('- Dots:', !!dotsContainer);

    let currentSlide = 0;
    const totalSlides = carouselImages.length;

    function createDots() {
        if (dotsContainer) {
            dotsContainer.innerHTML = ''; // Limpa dots existentes
            for (let i = 0; i < totalSlides; i++) {
                const dot = document.createElement('span');
                dot.classList.add('dot');
                dot.dataset.index = i;
                dotsContainer.appendChild(dot);

                dot.addEventListener('click', () => {
                    moveToSlide(i);
                });
            }
            console.log(`üîò ${totalSlides} dots criados`);
        }
    }

    function updateCarousel() {
        if (carouselSlides) {
            const offset = -currentSlide * 100;
            carouselSlides.style.transform = `translateX(${offset}%)`;
        }

        const dots = document.querySelectorAll('.dot');
        dots.forEach((dot) => {
            dot.classList.remove('active');
        });
        
        if (dots[currentSlide]) {
            dots[currentSlide].classList.add('active');
        }
    }

    function moveToSlide(index) {
        currentSlide = index;
        updateCarousel();
    }

    function showNextSlide() {
        currentSlide = (currentSlide + 1) % totalSlides;
        updateCarousel();
    }

    function showPrevSlide() {
        currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
        updateCarousel();
    }

    // Event listeners do carrossel
    if (prevButton) {
        prevButton.addEventListener('click', showPrevSlide);
    }
    
    if (nextButton) {
        nextButton.addEventListener('click', showNextSlide);
    }

    // Inicializa o carrossel apenas se houver imagens
    if (totalSlides > 0) {
        createDots();
        updateCarousel();
        
        // Auto-slide do carrossel
        let autoSlideInterval;
        
        function startAutoSlide() {
            stopAutoSlide();
            autoSlideInterval = setInterval(showNextSlide, 5000);
        }

        function stopAutoSlide() {
            if (autoSlideInterval) {
                clearInterval(autoSlideInterval);
            }
        }

        if (carouselContainer) {
            startAutoSlide();
            carouselContainer.addEventListener('mouseenter', stopAutoSlide);
            carouselContainer.addEventListener('mouseleave', startAutoSlide);
        }
        console.log('üé† Carrossel inicializado com sucesso');
    } else {
        console.warn("‚ö†Ô∏è Nenhuma imagem encontrada para o carrossel.");
        if (carouselContainer) {
            carouselContainer.style.display = 'none';
        }
    }

    /* ========================================
       L√ìGICA DO POPUP COM TRATAMENTO DE ERROS
    ======================================== */
    
    // Verifica elementos do popup com fun√ß√£o segura
    const popupElements = {
        overlay: safeElementExists('popup-overlay'),
        button: safeElementExists('popup-button'),
        vagasCount: safeElementExists('vagas-count'),
        alertMessage: safeElementExists('alert-message'),
        pessoasCount: safeElementExists('pessoas-count')
    };
    
    console.log('üéØ Verifica√ß√£o completa dos elementos do popup:');
    Object.entries(popupElements).forEach(([name, {exists}]) => {
        console.log(`- ${name}: ${exists ? '‚úÖ' : '‚ùå'}`);
    });
    
    // Vari√°veis de controle
    let vagasDisponiveis = POPUP_CONFIG.vagasIniciais;
    let pessoasQueColheram = POPUP_CONFIG.pessoasIniciais;
    let popupTimer;
    let countdownInterval;
    let buttonTimer;

    // Fun√ß√µes de atualiza√ß√£o seguras
    const updateVagasDisplay = () => {
        const success = safeElementUpdate('vagas-count', vagasDisponiveis, 'üìä ');
        if (!success) {
            console.log(`üìä Vagas atuais: ${vagasDisponiveis} (elemento n√£o encontrado no DOM)`);
        }
    };

    const updatePessoasDisplay = () => {
        const success = safeElementUpdate('pessoas-count', pessoasQueColheram, 'üë• ');
        if (!success) {
            console.log(`üë• Pessoas atuais: ${pessoasQueColheram} (elemento n√£o encontrado no DOM)`);
        }
    };

    const updateAlertMessage = (message) => {
        const success = safeElementUpdate('alert-message', message, '‚ö†Ô∏è ');
        if (!success) {
            console.log(`‚ö†Ô∏è Alerta: ${message} (elemento n√£o encontrado no DOM)`);
        }
    };

    const showPopup = () => {
        console.log('üéØ Executando showPopup...');
        
        if (!popupElements.overlay.exists) {
            console.error('‚ùå ERRO: popup-overlay n√£o encontrado - popup n√£o pode ser exibido!');
            return;
        }
        
        const popupOverlay = popupElements.overlay.element;
        
        // Mostra o overlay
        popupOverlay.style.display = 'block';
        document.body.classList.add('popup-active');
        console.log('‚úÖ Popup overlay exibido');

        // Adiciona classe show ap√≥s um pequeno delay para anima√ß√£o
        setTimeout(() => {
            popupOverlay.classList.add('show');
            console.log('‚úÖ Classe show adicionada ao popup');
        }, 50);

        // Prepara o bot√£o se existir
        if (popupElements.button.exists) {
            const popupButton = popupElements.button.element;
            popupButton.style.display = 'block';
            popupButton.style.opacity = '0';
            popupButton.style.visibility = 'hidden';
            popupButton.classList.remove('show');
            console.log('‚úÖ Bot√£o preparado (invis√≠vel)');
        } else {
            console.warn('‚ö†Ô∏è Bot√£o do popup n√£o encontrado - continuando sem bot√£o');
        }

        console.log(`‚è≥ Bot√£o aparecer√° em ${POPUP_CONFIG.tempoParaBotaoAparecer/1000} segundos...`);

        // Timer para mostrar o bot√£o
        buttonTimer = setTimeout(() => {
            if (popupElements.button.exists) {
                const popupButton = popupElements.button.element;
                console.log('üîò Mostrando bot√£o...');
                popupButton.style.visibility = 'visible';
                popupButton.style.opacity = '1';
                popupButton.classList.add('show');
                console.log('‚úÖ Bot√£o exibido com sucesso');
            } else {
                console.warn('‚ö†Ô∏è Bot√£o n√£o encontrado para exibir - continuando sem bot√£o');
            }
        }, POPUP_CONFIG.tempoParaBotaoAparecer);

        // Inicia contador de vagas
        startVagasCountdown();
    };

    const startVagasCountdown = () => {
        console.log('üîÑ Iniciando countdown das vagas...');
        
        // Limpa interval anterior se existir
        if (countdownInterval) {
            clearInterval(countdownInterval);
            console.log('üßπ Interval anterior limpo');
        }

        // Atualiza displays iniciais
        updateVagasDisplay();
        updatePessoasDisplay();

        console.log(`üìä Estado inicial - Vagas: ${vagasDisponiveis}, Pessoas: ${pessoasQueColheram}`);

        countdownInterval = setInterval(() => {
            console.log('‚è∞ Executando interval do countdown...');
            
            if (vagasDisponiveis > 0) {
                // Reduz vagas e aumenta pessoas
                vagasDisponiveis--;
                pessoasQueColheram += POPUP_CONFIG.incrementoPessoas;
                
                console.log(`üìâ Vagas reduzidas para: ${vagasDisponiveis}`);
                console.log(`üìà Pessoas aumentadas para: ${pessoasQueColheram}`);
                
                // Atualiza displays
                updateVagasDisplay();
                updatePessoasDisplay();

                // Verifica alertas
                if (vagasDisponiveis <= 5 && vagasDisponiveis > 0) {
                    updateAlertMessage('Voc√™ corre o risco de perder essa chance!');
                } else if (vagasDisponiveis <= 0) {
                    updateAlertMessage('As vagas se esgotaram!');
                    
                    // Esconde o bot√£o quando as vagas acabam
                    if (popupElements.button.exists) {
                        const popupButton = popupElements.button.element;
                        popupButton.classList.remove('show');
                        popupButton.style.opacity = '0';
                        popupButton.style.visibility = 'hidden';
                        console.log('üö´ Bot√£o escondido - vagas esgotadas');
                    }
                    
                    console.log('‚ùå Vagas esgotadas - parando countdown');
                    clearInterval(countdownInterval);
                }
            } else {
                console.log('‚èπÔ∏è Countdown finalizado');
                clearInterval(countdownInterval);
            }
        }, POPUP_CONFIG.intervaloVagas);
        
        console.log(`‚úÖ Countdown iniciado com intervalo de ${POPUP_CONFIG.intervaloVagas}ms`);
    };

    // Inicia o timer do popup
    console.log(`üöÄ Popup ser√° exibido em ${POPUP_CONFIG.tempoParaAparecer/1000} segundos...`);
    popupTimer = setTimeout(showPopup, POPUP_CONFIG.tempoParaAparecer);

    // Event listener do bot√£o de redirecionamento
    if (popupElements.button.exists) {
        const popupButton = popupElements.button.element;
        
        popupButton.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('üîó Clique no bot√£o detectado!');
            console.log('üîó Redirecionando para:', POPUP_CONFIG.linkRedirecionamento);
            
            // Limpa todos os timers antes de redirecionar
            if (popupTimer) clearTimeout(popupTimer);
            if (buttonTimer) clearTimeout(buttonTimer);
            if (countdownInterval) clearInterval(countdownInterval);
            
            window.location.href = POPUP_CONFIG.linkRedirecionamento;
        });

        // Efeitos de hover
        popupButton.addEventListener('mouseenter', function() {
            this.style.animationDuration = '0.5s';
            console.log('üñ±Ô∏è Mouse sobre o bot√£o');
        });
        
        popupButton.addEventListener('mouseleave', function() {
            this.style.animationDuration = '1.2s';
            console.log('üñ±Ô∏è Mouse saiu do bot√£o');
        });
        
        console.log('‚úÖ Event listeners do bot√£o adicionados');
    } else {
        console.warn('‚ö†Ô∏è Bot√£o popup n√£o encontrado - event listeners n√£o adicionados');
    }

    // FUN√á√ÉO DE DEBUG EXPANDIDA E MELHORADA
    window.debugPopup = {
        // Mostra popup imediatamente
        showNow: () => {
            console.log('üõ†Ô∏è DEBUG: For√ßando exibi√ß√£o do popup');
            clearTimeout(popupTimer);
            showPopup();
        },
        
        // Controles do bot√£o
        showButton: () => {
            console.log('üõ†Ô∏è DEBUG: For√ßando exibi√ß√£o do bot√£o');
            if (popupElements.button.exists) {
                const popupButton = popupElements.button.element;
                popupButton.style.visibility = 'visible';
                popupButton.style.opacity = '1';
                popupButton.classList.add('show');
                console.log('‚úÖ Bot√£o exibido via debug');
            } else {
                console.warn('‚ö†Ô∏è Bot√£o n√£o encontrado para debug');
            }
        },
        
        hideButton: () => {
            console.log('üõ†Ô∏è DEBUG: Escondendo bot√£o');
            if (popupElements.button.exists) {
                const popupButton = popupElements.button.element;
                popupButton.style.visibility = 'hidden';
                popupButton.style.opacity = '0';
                popupButton.classList.remove('show');
                console.log('‚úÖ Bot√£o escondido via debug');
            } else {
                console.warn('‚ö†Ô∏è Bot√£o n√£o encontrado para debug');
            }
        },
        
        // For√ßa atualiza√ß√£o dos contadores
        updateCounters: () => {
            console.log('üõ†Ô∏è DEBUG: Atualizando contadores');
            updateVagasDisplay();
            updatePessoasDisplay();
        },
        
        // Simula redu√ß√£o de vaga
        reduceVaga: () => {
            console.log('üõ†Ô∏è DEBUG: Simulando redu√ß√£o de vaga');
            if (vagasDisponiveis > 0) {
                vagasDisponiveis--;
                pessoasQueColheram += POPUP_CONFIG.incrementoPessoas;
                updateVagasDisplay();
                updatePessoasDisplay();
                console.log(`üõ†Ô∏è Nova situa√ß√£o - Vagas: ${vagasDisponiveis}, Pessoas: ${pessoasQueColheram}`);
            } else {
                console.log('üõ†Ô∏è N√£o h√° mais vagas para reduzir');
            }
        },
        
        // Configura√ß√µes e status
        config: POPUP_CONFIG,
        
        status: () => {
            return {
                vagas: vagasDisponiveis,
                pessoas: pessoasQueColheram,
                timers: {
                    popup: !!popupTimer,
                    button: !!buttonTimer,
                    countdown: !!countdownInterval
                },
                elementos: Object.fromEntries(
                    Object.entries(popupElements).map(([key, {exists}]) => [key, exists])
                )
            };
        },
        
        // Verifica elementos atualizados
        checkElements: () => {
            console.log('üîç VERIFICA√á√ÉO ATUAL DOS ELEMENTOS:');
            const currentCheck = {
                'popup-overlay': !!document.getElementById('popup-overlay'),
                'popup-button': !!document.getElementById('popup-button'),
                'vagas-count': !!document.getElementById('vagas-count'),
                'pessoas-count': !!document.getElementById('pessoas-count'),
                'alert-message': !!document.getElementById('alert-message')
            };
            
            Object.entries(currentCheck).forEach(([id, exists]) => {
                console.log(`- #${id}: ${exists ? '‚úÖ' : '‚ùå'}`);
            });
            
            return currentCheck;
        },
        
        // Cria elementos ausentes dinamicamente (√∫til para testes)
        createMissingElements: () => {
            console.log('üõ†Ô∏è DEBUG: Criando elementos ausentes...');
            
            const elementsToCreate = [
                { id: 'vagas-count', tag: 'span', text: vagasDisponiveis },
                { id: 'pessoas-count', tag: 'span', text: pessoasQueColheram },
                { id: 'alert-message', tag: 'div', text: 'Sistema funcionando' }
            ];
            
            elementsToCreate.forEach(({id, tag, text}) => {
                if (!document.getElementById(id)) {
                    const element = document.createElement(tag);
                    element.id = id;
                    element.textContent = text;
                    element.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #333; color: white; padding: 5px; z-index: 9999; margin: 5px;';
                    document.body.appendChild(element);
                    console.log(`‚úÖ Elemento #${id} criado dinamicamente`);
                } else {
                    console.log(`‚ÑπÔ∏è Elemento #${id} j√° existe`);
                }
            });
            
            // Atualiza a verifica√ß√£o dos elementos
            Object.assign(popupElements, {
                vagasCount: safeElementExists('vagas-count'),
                pessoasCount: safeElementExists('pessoas-count'),
                alertMessage: safeElementExists('alert-message')
            });
        }
    };

    console.log('üöÄ Sistema inicializado com sucesso!');
    console.log('üìã Resumo da inicializa√ß√£o:');
    console.log(`üìä Popup aparecer√° em ${POPUP_CONFIG.tempoParaAparecer/1000} segundos`);
    console.log(`üîò Bot√£o aparecer√° ${POPUP_CONFIG.tempoParaBotaoAparecer/1000} segundos ap√≥s o popup`);
    console.log(`üîó Link de redirecionamento: ${POPUP_CONFIG.linkRedirecionamento}`);
    console.log(`üë• Pessoas iniciais: ${POPUP_CONFIG.pessoasIniciais} | Incremento: +${POPUP_CONFIG.incrementoPessoas} por vaga`);
    console.log('üõ†Ô∏è Use window.debugPopup no console para testes e diagn√≥sticos');
    
    // Diagn√≥stico final melhorado
    console.log('üîç DIAGN√ìSTICO FINAL:');
    Object.entries(popupElements).forEach(([nome, {exists}]) => {
        console.log(`- ${nome}: ${exists ? '‚úÖ' : '‚ùå'}`);
    });
    
    // Aviso sobre elementos ausentes
    const missingElements = Object.entries(popupElements)
        .filter(([, {exists}]) => !exists)
        .map(([name]) => name);
    
    if (missingElements.length > 0) {
        console.warn('‚ö†Ô∏è ATEN√á√ÉO: Elementos ausentes detectados:', missingElements);
        console.log('üí° DICA: Use window.debugPopup.createMissingElements() para criar elementos de teste');
        console.log('üí° DICA: Use window.debugPopup.checkElements() para verificar elementos novamente');
    }

});
